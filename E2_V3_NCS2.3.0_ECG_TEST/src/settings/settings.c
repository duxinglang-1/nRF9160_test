#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <zephyr/kernel.h>
#include <zephyr/sys/printk.h>
#include <zephyr/fs/nvs.h>
#include <dk_buttons_and_leds.h>
#include "screen.h"
#include "settings.h"
#include "datetime.h"
#ifdef CONFIG_ALARM_SUPPORT
#include "alarm.h"
#endif
#include "lcd.h"
#include "codetrans.h"
#include "inner_flash.h"
#include "logger.h"

bool need_save_settings = false;
bool need_save_time = false;
bool need_reset_settings = false;
bool need_reset_bk_level = false;

uint8_t g_fw_version[64] = VERSION_STR LANG_BRANCH;

RESET_STATUS g_reset_status = RESET_STATUS_IDLE;

static bool reset_redraw_flag = false;
static bool reset_start_flag = false;
static bool reset_reboot_flag = false;

static uint8_t main_menu_index_bk = 0;

global_settings_t global_settings = {0};
settings_menu_t settings_menu = {0};

static void FactoryResetCallBack(struct k_timer *timer_id);
K_TIMER_DEFINE(reset_timer, FactoryResetCallBack, NULL);
static void FactoryResetStartCallBack(struct k_timer *timer_id);
K_TIMER_DEFINE(reset_start_timer, FactoryResetStartCallBack, NULL);

extern sys_date_timer_t date_time;

static void SettingsMenuDumpProc(void);
static void SettingsMainMenu1Proc(void);
static void SettingsMainMenu2Proc(void);
static void SettingsMainMenu3Proc(void);
static void SettingsMainMenu4Proc(void);
static void SettingsMainMenu5Proc(void);
static void SettingsMainMenu6Proc(void);
static void SettingsMainMenu7Proc(void);
static void SettingsMenuLang1Proc(void);
static void SettingsMenuLang2Proc(void);
static void SettingsMenuLang3Proc(void);
static void SettingsMenuLang4Proc(void);
static void SettingsMenuLang5Proc(void);
static void SettingsMenuLang6Proc(void);
static void SettingsMenuReset1Proc(void);
static void SettingsMenuReset2Proc(void);
static void SettingsMenuCaremateQRProc(void);
static void SettingsMenuOTAProc(void);
static void SettingsMenuBrightness1Proc(void);
static void SettingsMenuBrightness2Proc(void);
static void SettingsMenuBrightness3Proc(void);
static void SettingsMenuTemp1Proc(void);
static void SettingsMenuTemp2Proc(void);
static void SettingsMenuPgUpProc(void);
static void SettingsMenuPgDownProc(void);
static void SettingsMenuPgLeftProc(void);
static void SettingsMenuPgRightProc(void);
static void SettingsMenuDeviceProc(void);
static void SettingsMenuSIMProc(void);
static void SettingsMenuFWProc(void);

const sys_date_timer_t FACTORY_DEFAULT_TIME = 
{
	2023,
	1,
	1,
	0,
	0,
	0,
	0		//0=sunday
};

const global_settings_t FACTORY_DEFAULT_SETTINGS = 
{
	SETTINGS_STATUS_NORMAL,	//status flag
	false,					//heart rate turn on
	false,					//blood pressure turn on
	false,					//blood oxygen turn on		
	true,					//wake screen by wrist
	false,					//wrist off check
	false,					//fall check
	3,						//location type: 1:only wifi,2:only gps,3:wifi+gps,4:gps+wifi
	0,						//target steps
	60,						//health interval
	TEMP_UINT_C,			//Centigrade
	TIME_FORMAT_24,			//24 format
#ifdef FW_FOR_CN	
	LANGUAGE_CHN,			//language
#else
	LANGUAGE_EN,			//language
#endif
	DATE_FORMAT_YYYYMMDD,	//date format
	CLOCK_MODE_DIGITAL,		//colck mode
	BACKLIGHT_10_SEC,		//backlight time
	BACKLIGHT_LEVEL_2,		//backlight level
	{true,1},				//PHD
	{500,60},				//position interval
	{120,75},				//pb calibration
	{						//alarm
		{false,0,0,0},		
		{false,0,0,0},
		{false,0,0,0},
		{false,0,0,0},
		{false,0,0,0},
		{false,0,0,0},
		{false,0,0,0},
		{false,0,0,0},
	},
};

const settings_menu_t SETTING_MAIN_MENU = 
{
	SETTINGS_MENU_MAIN,
	0,
	7,
	{
	#ifndef FW_FOR_CN
		{
			{0x004c,0x0061,0x006e,0x0067,0x0075,0x0061,0x0067,0x0065,0x0000},//language
			{0x0042,0x0072,0x0069,0x0067,0x0068,0x0074,0x006e,0x0065,0x0073,0x0073,0x0000},//Brightness
			{0x0054,0x0065,0x006d,0x0070,0x0020,0x0064,0x0069,0x0073,0x0070,0x006c,0x0061,0x0079,0x0000},//Temp display
			{0x0044,0x0065,0x0076,0x0069,0x0063,0x0065,0x0020,0x0049,0x006e,0x0066,0x006f,0x0000},//Device info
			{0x0043,0x0061,0x0072,0x0065,0x006D,0x0061,0x0074,0x0065,0x0020,0x0051,0x0052,0x0000},//Caremate QR
			{0x0046,0x0061,0x0063,0x0074,0x006f,0x0072,0x0079,0x0020,0x0064,0x0065,0x0066,0x0061,0x0075,0x006c,0x0074,0x0000},//Factory default
			{0x004f,0x0054,0x0041,0x0020,0x0055,0x0070,0x0064,0x0061,0x0074,0x0065,0x0000},//OTA Update
		},
		{
			{0x0053,0x0070,0x0072,0x0061,0x0063,0x0068,0x0065,0x0000},//Sprache
			{0x0048,0x0065,0x006C,0x006C,0x0069,0x0067,0x006B,0x0065,0x0069,0x0074,0x0000},//Helligkeit
			{0x0054,0x0065,0x006D,0x0070,0x002E,0x0020,0x0041,0x006E,0x007A,0x0065,0x0069,0x0067,0x0065,0x0000},//Temp. Anzeige
			{0x0047,0x0065,0x0072,0x00E4,0x0074,0x0065,0x0020,0x0049,0x006E,0x0066,0x006F,0x0000},//Ger?te Info
			{0x0043,0x0061,0x0072,0x0065,0x006D,0x0061,0x0074,0x0065,0x0020,0x0051,0x0052,0x0000},////Caremate QR
			{0x0057,0x0065,0x0072,0x006B,0x0073,0x0065,0x0069,0x006E,0x0073,0x0074,0x0065,0x006C,0x006C,0x0075,0x006E,0x0067,0x0000},//Werkseinstellung
			{0x004f,0x0054,0x0041,0x0020,0x0055,0x0070,0x0064,0x0061,0x0074,0x0065,0x0000},//OTA Update
		},
		{
			{0x004C,0x0061,0x006E,0x0067,0x0075,0x0065,0x0000},//Langue
			{0x004C,0x0075,0x006D,0x0069,0x006E,0x006F,0x0073,0x0069,0x0074,0x00E9,0x0000},//Luminosit��
			{0x0041,0x0066,0x0066,0x0069,0x0063,0x0068,0x0061,0x0067,0x0065,0x0020,0x0074,0x0065,0x006D,0x0070,0x006F,0x0072,0x0061,0x0069,0x0072,0x0065,0x0000},//Affichage temporaire
			{0x0049,0x006E,0x0066,0x006F,0x0020,0x0061,0x0070,0x0070,0x0061,0x0072,0x0065,0x0069,0x006C,0x0000},//Info appareil
			{0x0043,0x0061,0x0072,0x0065,0x006D,0x0061,0x0074,0x0065,0x0020,0x0051,0x0052,0x0000},////Caremate QR
			{0x0044,0x00E9,0x0066,0x0061,0x0075,0x0074,0x0020,0x0064,0x0065,0x0020,0x0066,0x0061,0x0062,0x0072,0x0069,0x0063,0x0061,0x0074,0x0069,0x006F,0x006E,0x0000},//D��faut de fabrication
			{0x004D,0x0069,0x0073,0x0065,0x0020,0x00E0,0x0020,0x006A,0x006F,0x0075,0x0072,0x0020,0x004F,0x0054,0x0041,0x0000},//Mise �� jour OTA
		},
		{
			{0x004C,0x0069,0x006E,0x0067,0x0075,0x0061,0x0000},//Lingua
			{0x004C,0x0075,0x006D,0x0069,0x006E,0x006F,0x0073,0x0069,0x0074,0x00E0,0x0000},//Luminosit��
			{0x0055,0x006E,0x0069,0x0074,0x00E0,0x0020,0x0064,0x0069,0x0020,0x0074,0x0065,0x006D,0x0070,0x0000},//Unit�� di temp
			{0x0049,0x006E,0x0066,0x006F,0x0020,0x0073,0x0075,0x006C,0x0020,0x0064,0x0069,0x0073,0x0070,0x006F,0x0073,0x0069,0x0074,0x0069,0x0076,0x006F,0x0000},//Info sul dispositivo
			{0x0043,0x0061,0x0072,0x0065,0x006D,0x0061,0x0074,0x0065,0x0020,0x0051,0x0052,0x0000},////Caremate QR
			{0x0049,0x006D,0x0070,0x006F,0x0073,0x0074,0x0061,0x007A,0x0069,0x006F,0x006E,0x0065,0x0020,0x0064,0x0069,0x0020,0x0066,0x0061,0x0062,0x0062,0x0072,0x0069,0x0063,0x0061,0x0000},//Impostazione di fabbrica
			{0x0041,0x0067,0x0067,0x0069,0x006F,0x0072,0x006E,0x0061,0x006D,0x0065,0x006E,0x0074,0x006F,0x0020,0x004F,0x0054,0x0041,0x0000},//Aggiornamento OTA
		},
		{
			{0x0049,0x0064,0x0069,0x006F,0x006D,0x0061,0x0000},//Idioma
			{0x004C,0x0075,0x006D,0x0069,0x006E,0x006F,0x0073,0x0069,0x0064,0x0061,0x0064,0x0000},//Luminosidad
			{0x0055,0x006E,0x0069,0x0064,0x0061,0x0064,0x0020,0x0054,0x0065,0x006D,0x0070,0x0000},//Unidad Temp
			{0x0049,0x006E,0x0066,0x006F,0x0020,0x0064,0x0065,0x006C,0x0020,0x0064,0x0069,0x0073,0x0070,0x006F,0x0073,0x0069,0x0074,0x0069,0x0076,0x006F,0x0000},//Info del dispositivo
			{0x0043,0x0061,0x0072,0x0065,0x006D,0x0061,0x0074,0x0065,0x0020,0x0051,0x0052,0x0000},////Caremate QR
			{0x0041,0x006A,0x0075,0x0073,0x0074,0x0065,0x0073,0x0020,0x0064,0x0065,0x0020,0x0066,0x00E1,0x0062,0x0072,0x0069,0x0063,0x0061,0x0000},//Ajustes de f��brica
			{0x0041,0x0063,0x0074,0x0075,0x0061,0x006C,0x0069,0x007A,0x0061,0x0063,0x0069,0x00F3,0x006E,0x0020,0x004F,0x0054,0x0041,0x0000},//Actualizaci��n OTA
		},
		{
			{0x004C,0x0069,0x006E,0x0067,0x0075,0x0061,0x0067,0x0065,0x006D,0x0000},//Linguagem
			{0x0042,0x0072,0x0069,0x006C,0x0068,0x006F,0x0000},//Brilho
			{0x0055,0x006E,0x0069,0x0064,0x0061,0x0064,0x0065,0x0020,0x0064,0x0065,0x0020,0x0074,0x0065,0x006D,0x0070,0x0000},//Unidade de temp
			{0x0049,0x006E,0x0066,0x006F,0x0020,0x0064,0x006F,0x0020,0x0064,0x0069,0x0073,0x0070,0x006F,0x0073,0x0069,0x0074,0x0069,0x0076,0x006F,0x0000},//Info do dispositivo
			{0x0043,0x0061,0x0072,0x0065,0x006D,0x0061,0x0074,0x0065,0x0020,0x0051,0x0052,0x0000},////Caremate QR
			{0x0050,0x0072,0x0065,0x0064,0x0065,0x0066,0x0069,0x006E,0x0069,0x00E7,0x00E3,0x006F,0x0020,0x0064,0x0065,0x0020,0x0066,0x00E1,0x0062,0x0072,0x0069,0x0063,0x0061,0x0000},//Predefini??o de f��brica
			{0x0041,0x0074,0x0075,0x0061,0x006C,0x0069,0x007A,0x0061,0x00E7,0x00E3,0x006F,0x0020,0x004F,0x0054,0x0041,0x0000},//Atualiza??o OTA
		},
	#else
		{
			{0x8BED,0x8A00,0x0000},//����
			{0x5C4F,0x5E55,0x4EAE,0x5EA6,0x0000},//��Ļ����
			{0x4F53,0x6E29,0x663E,0x793A,0x0000},//������ʾ
			{0x8BBE,0x5907,0x4FE1,0x606F,0x0000},//�豸��Ϣ
			{0x0043,0x0061,0x0072,0x0065,0x006D,0x0061,0x0074,0x0065,0x4E8C,0x7EF4,0x7801,0x0000},//Caremate��ά��
			{0x6062,0x590D,0x51FA,0x5382,0x8BBE,0x7F6E,0x0000},//�ָ���������
			{0x004F,0x0054,0x0041,0x5347,0x7EA7,0x0000},//OTA����
		},
		{
			{0x004c,0x0061,0x006e,0x0067,0x0075,0x0061,0x0067,0x0065,0x0000},//language
			{0x0042,0x0072,0x0069,0x0067,0x0068,0x0074,0x006e,0x0065,0x0073,0x0073,0x0000},//Brightness
			{0x0054,0x0065,0x006d,0x0070,0x0020,0x0064,0x0069,0x0073,0x0070,0x006c,0x0061,0x0079,0x0000},//Temp display
			{0x0044,0x0065,0x0076,0x0069,0x0063,0x0065,0x0020,0x0049,0x006e,0x0066,0x006f,0x0000},//Device info
			{0x0043,0x0061,0x0072,0x0065,0x006D,0x0061,0x0074,0x0065,0x0020,0x0051,0x0052,0x0000},//Caremate QR
			{0x0046,0x0061,0x0063,0x0074,0x006f,0x0072,0x0079,0x0020,0x0064,0x0065,0x0066,0x0061,0x0075,0x006c,0x0074,0x0000},//Factory default
			{0x004f,0x0054,0x0041,0x0020,0x0055,0x0070,0x0064,0x0061,0x0074,0x0065,0x0000},//OTA Update
		},
	#endif
	},
	{
		//select proc func
		SettingsMainMenu1Proc,
		SettingsMainMenu2Proc,
		SettingsMainMenu3Proc,
		SettingsMainMenu4Proc,
		SettingsMainMenu5Proc,
		SettingsMainMenu6Proc,
		SettingsMainMenu7Proc,
	},
	{	
		//page proc func
		SettingsMenuPgUpProc,
		SettingsMenuPgDownProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
	},
};

const settings_menu_t SETTING_MENU_LANGUAGE = 
{
	SETTINGS_MENU_LANGUAGE,
	0,
#ifndef FW_FOR_CN
	6,
#else
	2,
#endif
	{
	#ifndef FW_FOR_CN
		{
			{0x0045,0x006E,0x0067,0x006C,0x0069,0x0073,0x0068,0x0000},//English
			{0x0044,0x0065,0x0075,0x0074,0x0073,0x0063,0x0068,0x0000},//Deutsch
			{0x0046,0x0072,0x0061,0x006E,0x00E7,0x0061,0x0069,0x0073,0x0000},//Fran?ais
			{0x0049,0x0074,0x0061,0x006C,0x0069,0x0061,0x006E,0x006F,0x0000},//Italiano
			{0x0045,0x0073,0x0070,0x0061,0x00F1,0x006F,0x006C,0x0000},//Espa?ol
			{0x0050,0x006F,0x0072,0x0074,0x0075,0x0067,0x0075,0x00EA,0x0073,0x0000},//Portugu��s
		},
		{
			{0x0045,0x006E,0x0067,0x006C,0x0069,0x0073,0x0068,0x0000},//English
			{0x0044,0x0065,0x0075,0x0074,0x0073,0x0063,0x0068,0x0000},//Deutsch
			{0x0046,0x0072,0x0061,0x006E,0x00E7,0x0061,0x0069,0x0073,0x0000},//Fran?ais
			{0x0049,0x0074,0x0061,0x006C,0x0069,0x0061,0x006E,0x006F,0x0000},//Italiano
			{0x0045,0x0073,0x0070,0x0061,0x00F1,0x006F,0x006C,0x0000},//Espa?ol
			{0x0050,0x006F,0x0072,0x0074,0x0075,0x0067,0x0075,0x00EA,0x0073,0x0000},//Portugu��s
		},
		{
			{0x0045,0x006E,0x0067,0x006C,0x0069,0x0073,0x0068,0x0000},//English
			{0x0044,0x0065,0x0075,0x0074,0x0073,0x0063,0x0068,0x0000},//Deutsch
			{0x0046,0x0072,0x0061,0x006E,0x00E7,0x0061,0x0069,0x0073,0x0000},//Fran?ais
			{0x0049,0x0074,0x0061,0x006C,0x0069,0x0061,0x006E,0x006F,0x0000},//Italiano
			{0x0045,0x0073,0x0070,0x0061,0x00F1,0x006F,0x006C,0x0000},//Espa?ol
			{0x0050,0x006F,0x0072,0x0074,0x0075,0x0067,0x0075,0x00EA,0x0073,0x0000},//Portugu��s
		},
		{
			{0x0045,0x006E,0x0067,0x006C,0x0069,0x0073,0x0068,0x0000},//English
			{0x0044,0x0065,0x0075,0x0074,0x0073,0x0063,0x0068,0x0000},//Deutsch
			{0x0046,0x0072,0x0061,0x006E,0x00E7,0x0061,0x0069,0x0073,0x0000},//Fran?ais
			{0x0049,0x0074,0x0061,0x006C,0x0069,0x0061,0x006E,0x006F,0x0000},//Italiano
			{0x0045,0x0073,0x0070,0x0061,0x00F1,0x006F,0x006C,0x0000},//Espa?ol
			{0x0050,0x006F,0x0072,0x0074,0x0075,0x0067,0x0075,0x00EA,0x0073,0x0000},//Portugu��s
		},
		{
			{0x0045,0x006E,0x0067,0x006C,0x0069,0x0073,0x0068,0x0000},//English
			{0x0044,0x0065,0x0075,0x0074,0x0073,0x0063,0x0068,0x0000},//Deutsch
			{0x0046,0x0072,0x0061,0x006E,0x00E7,0x0061,0x0069,0x0073,0x0000},//Fran?ais
			{0x0049,0x0074,0x0061,0x006C,0x0069,0x0061,0x006E,0x006F,0x0000},//Italiano
			{0x0045,0x0073,0x0070,0x0061,0x00F1,0x006F,0x006C,0x0000},//Espa?ol
			{0x0050,0x006F,0x0072,0x0074,0x0075,0x0067,0x0075,0x00EA,0x0073,0x0000},//Portugu��s
		},
		{
			{0x0045,0x006E,0x0067,0x006C,0x0069,0x0073,0x0068,0x0000},//English
			{0x0044,0x0065,0x0075,0x0074,0x0073,0x0063,0x0068,0x0000},//Deutsch
			{0x0046,0x0072,0x0061,0x006E,0x00E7,0x0061,0x0069,0x0073,0x0000},//Fran?ais
			{0x0049,0x0074,0x0061,0x006C,0x0069,0x0061,0x006E,0x006F,0x0000},//Italiano
			{0x0045,0x0073,0x0070,0x0061,0x00F1,0x006F,0x006C,0x0000},//Espa?ol
			{0x0050,0x006F,0x0072,0x0074,0x0075,0x0067,0x0075,0x00EA,0x0073,0x0000},//Portugu��s
		},
	#else	
		{
			{0x4E2D,0x6587,0x0000},//����
			{0x0045,0x006E,0x0067,0x006C,0x0069,0x0073,0x0068,0x0000},//English
		},
		{
			{0x4E2D,0x6587,0x0000},//����
			{0x0045,0x006E,0x0067,0x006C,0x0069,0x0073,0x0068,0x0000},//English
		},
	#endif	
	},
	{
	#ifndef FW_FOR_CN
		SettingsMenuLang1Proc,
		SettingsMenuLang2Proc,
		SettingsMenuLang3Proc,
		SettingsMenuLang4Proc,
		SettingsMenuLang5Proc,
		SettingsMenuLang6Proc,
	#else
		SettingsMenuLang1Proc,
		SettingsMenuLang2Proc,
	#endif
	},
	{	
		//page proc func
		SettingsMenuPgUpProc,
		SettingsMenuPgDownProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
	},	
};

const settings_menu_t SETTING_MENU_CAREMATE_QR = 
{
	SETTINGS_MENU_CAREMATE_QR,
	0,
	1,
	{
		{
			{0x0000},
		},
		{
			{0x0000},
		},
		{
			{0x0000},
		},		
	},
	{
		SettingsMenuCaremateQRProc,
	},
	{	
		//page proc func
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
	},	
};

const settings_menu_t SETTING_MENU_FACTORY_RESET = 
{
	SETTINGS_MENU_FACTORY_RESET,
	0,
	2,
	{
		{
			{0x0000},
			{0x0000},
		},
		{
			{0x0000},
			{0x0000},
		},
		{
			{0x0000},
			{0x0000},
		},		
	},
	{
		SettingsMenuReset1Proc,
		SettingsMenuReset2Proc,
	},
	{	
		//page proc func
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
	},	
};

const settings_menu_t SETTING_MENU_OTA_UPDATE = 
{
	SETTINGS_MENU_OTA,
	0,
	1,
	{
		{
			{0x0000},
		},
		{
			{0x0000},
		},
		{
			{0x0000},
		},		
	},
	{
		SettingsMenuOTAProc,
	},
	{	
		//page proc func
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
	},	
};


const settings_menu_t SETTING_MENU_BRIGHTNESS = 
{
	SETTINGS_MENU_BRIGHTNESS,
	0,
	2,
	{
		{
			{0x0000},
			{0x0000},
		},
		{
			{0x0000},
			{0x0000},
		},
		{
			{0x0000},
			{0x0000},
		},
	},	
	{
		SettingsMenuBrightness1Proc,
		SettingsMenuBrightness2Proc,
		SettingsMenuBrightness3Proc,
	},
	{	
		//page proc func
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
		SettingsMenuBrightness1Proc,
		SettingsMenuBrightness2Proc,		
	},
};

const settings_menu_t SETTING_MENU_TEMP = 
{
	SETTINGS_MENU_TEMP,
	0,
	2,
	{
	#ifndef FW_FOR_CN
		{
			{0x0043,0x0065,0x006C,0x0073,0x0069,0x0075,0x0073,0x0000},//Celsius
			{0x0046,0x0061,0x0068,0x0072,0x0065,0x006E,0x0068,0x0065,0x0069,0x0074,0x0000},//Fahrenheit
		},
		{
			{0x0043,0x0065,0x006C,0x0073,0x0069,0x0075,0x0073,0x0000},//Celsius
			{0x0046,0x0061,0x0068,0x0072,0x0065,0x006E,0x0068,0x0065,0x0069,0x0074,0x0000},//Fahrenheit
		},
		{
			{0x0043,0x0065,0x006C,0x0073,0x0069,0x0075,0x0073,0x0000},//Celsius
			{0x0046,0x0061,0x0068,0x0072,0x0065,0x006E,0x0068,0x0065,0x0069,0x0074,0x0000},//Fahrenheit
		},
		{
			{0x0043,0x0065,0x006C,0x0073,0x0069,0x0075,0x0073,0x0000},//Celsius
			{0x0046,0x0061,0x0068,0x0072,0x0065,0x006E,0x0068,0x0065,0x0069,0x0074,0x0000},//Fahrenheit
		},
		{
			{0x0043,0x0065,0x006C,0x0073,0x0069,0x0075,0x0073,0x0000},//Celsius
			{0x0046,0x0061,0x0068,0x0072,0x0065,0x006E,0x0068,0x0065,0x0069,0x0074,0x0000},//Fahrenheit
		},
		{
			{0x0043,0x0065,0x006C,0x0073,0x0069,0x0075,0x0073,0x0000},//Celsius
			{0x0046,0x0061,0x0068,0x0072,0x0065,0x006E,0x0068,0x0065,0x0069,0x0074,0x0000},//Fahrenheit
		},
	#else
		{
			{0x6444,0x6C0F,0x5EA6,0x0000},//���϶�
			{0x534E,0x6C0F,0x5EA6,0x0000},//���϶�
		},
		{
			{0x0043,0x0065,0x006C,0x0073,0x0069,0x0075,0x0073,0x0000},//Celsius
			{0x0046,0x0061,0x0068,0x0072,0x0065,0x006E,0x0068,0x0065,0x0069,0x0074,0x0000},//Fahrenheit
		},
	#endif
	},
	{
		SettingsMenuTemp1Proc,
		SettingsMenuTemp2Proc,
	},
	{	
		//page proc func
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
	},	
};

const settings_menu_t SETTING_MENU_DEVICE = 
{
	SETTINGS_MENU_DEVICE,
	0,
#ifdef CONFIG_FACTORY_TEST_SUPPORT
	9,
#else
	3,
#endif	
	{
	#ifndef FW_FOR_CN
	  #ifdef CONFIG_FACTORY_TEST_SUPPORT
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x0049,0x0043,0x0043,0x0049,0x0044,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//ICCID No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
			{0x004D,0x004F,0x0044,0x0045,0x004D,0x003A,0x0000},//MODEM:
			{0x0050,0x0050,0x0047,0x003A,0x0000},//PPG:
			{0x0057,0x0069,0x0046,0x0069,0x003A,0x0000},//WiFi:
			{0x0042,0x004C,0x0045,0x003A,0x0000},//BLE:
			{0x0042,0x004C,0x0045,0x0020,0x004D,0x0041,0x0043,0x003A,0x0000},//BLE MAC:						
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x0049,0x0043,0x0043,0x0049,0x0044,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//ICCID No.:	
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
			{0x004D,0x004F,0x0044,0x0045,0x004D,0x003A,0x0000},//MODEM:
			{0x0050,0x0050,0x0047,0x003A,0x0000},//PPG:
			{0x0057,0x0069,0x0046,0x0069,0x003A,0x0000},//WiFi:
			{0x0042,0x004C,0x0045,0x003A,0x0000},//BLE:
			{0x0042,0x004C,0x0045,0x0020,0x004D,0x0041,0x0043,0x003A,0x0000},//BLE MAC:
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x0049,0x0043,0x0043,0x0049,0x0044,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//ICCID No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
			{0x004D,0x004F,0x0044,0x0045,0x004D,0x003A,0x0000},//MODEM:
			{0x0050,0x0050,0x0047,0x003A,0x0000},//PPG:
			{0x0057,0x0069,0x0046,0x0069,0x003A,0x0000},//WiFi:
			{0x0042,0x004C,0x0045,0x003A,0x0000},//BLE:
			{0x0042,0x004C,0x0045,0x0020,0x004D,0x0041,0x0043,0x003A,0x0000},//BLE MAC:
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x0049,0x0043,0x0043,0x0049,0x0044,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//ICCID No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
			{0x004D,0x004F,0x0044,0x0045,0x004D,0x003A,0x0000},//MODEM:
			{0x0050,0x0050,0x0047,0x003A,0x0000},//PPG:
			{0x0057,0x0069,0x0046,0x0069,0x003A,0x0000},//WiFi:
			{0x0042,0x004C,0x0045,0x003A,0x0000},//BLE:
			{0x0042,0x004C,0x0045,0x0020,0x004D,0x0041,0x0043,0x003A,0x0000},//BLE MAC:						
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x0049,0x0043,0x0043,0x0049,0x0044,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//ICCID No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
			{0x004D,0x004F,0x0044,0x0045,0x004D,0x003A,0x0000},//MODEM:
			{0x0050,0x0050,0x0047,0x003A,0x0000},//PPG:
			{0x0057,0x0069,0x0046,0x0069,0x003A,0x0000},//WiFi:
			{0x0042,0x004C,0x0045,0x003A,0x0000},//BLE:
			{0x0042,0x004C,0x0045,0x0020,0x004D,0x0041,0x0043,0x003A,0x0000},//BLE MAC:						
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x0049,0x0043,0x0043,0x0049,0x0044,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//ICCID No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
			{0x004D,0x004F,0x0044,0x0045,0x004D,0x003A,0x0000},//MODEM:
			{0x0050,0x0050,0x0047,0x003A,0x0000},//PPG:
			{0x0057,0x0069,0x0046,0x0069,0x003A,0x0000},//WiFi:
			{0x0042,0x004C,0x0045,0x003A,0x0000},//BLE:
			{0x0042,0x004C,0x0045,0x0020,0x004D,0x0041,0x0043,0x003A,0x0000},//BLE MAC:						
		},
	  #else
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
		},
	  #endif/*CONFIG_FACTORY_TEST_SUPPORT*/
	#else
	  #ifdef CONFIG_FACTORY_TEST_SUPPORT
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x0049,0x0043,0x0043,0x0049,0x0044,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//ICCID No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
			{0x004D,0x004F,0x0044,0x0045,0x004D,0x003A,0x0000},//MODEM:
			{0x0050,0x0050,0x0047,0x003A,0x0000},//PPG:
			{0x0057,0x0069,0x0046,0x0069,0x003A,0x0000},//WiFi:
			{0x0042,0x004C,0x0045,0x003A,0x0000},//BLE:
			{0x0042,0x004C,0x0045,0x0020,0x004D,0x0041,0x0043,0x003A,0x0000},//BLE MAC:						
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x0049,0x0043,0x0043,0x0049,0x0044,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//ICCID No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
			{0x004D,0x004F,0x0044,0x0045,0x004D,0x003A,0x0000},//MODEM:
			{0x0050,0x0050,0x0047,0x003A,0x0000},//PPG:
			{0x0057,0x0069,0x0046,0x0069,0x003A,0x0000},//WiFi:
			{0x0042,0x004C,0x0045,0x003A,0x0000},//BLE:
			{0x0042,0x004C,0x0045,0x0020,0x004D,0x0041,0x0043,0x003A,0x0000},//BLE MAC:						
		},
	  #else
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
		},
		{
			{0x0049,0x004D,0x0045,0x0049,0x003A,0x0000},//IMEI:
			{0x0049,0x004D,0x0053,0x0049,0x0020,0x004E,0x006F,0x002E,0x003A,0x0000},//IMSI No.:
			{0x004D,0x0043,0x0055,0x003A,0x0000},//MCU:
		},
	  #endif/*CONFIG_FACTORY_TEST_SUPPORT*/
	#endif
	},
	{
		SettingsMenuDeviceProc,
		SettingsMenuDeviceProc,
		SettingsMenuDeviceProc,
		SettingsMenuDeviceProc,
		SettingsMenuDeviceProc,
		SettingsMenuDeviceProc,
		SettingsMenuDeviceProc,
		SettingsMenuDeviceProc,
		SettingsMenuDeviceProc,
	},
	{	
		//page proc func
		SettingsMenuPgUpProc,
		SettingsMenuPgDownProc,
		SettingsMenuDumpProc,
		SettingsMenuDumpProc,
	},	
};

void FactoryResetCallBack(struct k_timer *timer_id)
{
	switch(g_reset_status)
	{
	case RESET_STATUS_IDLE:
		break;

	case RESET_STATUS_RUNNING:
		g_reset_status = RESET_STATUS_FAIL;
		reset_redraw_flag = true;
		break;

	case RESET_STATUS_SUCCESS:
		reset_reboot_flag = true;
		break;

	case RESET_STATUS_FAIL:
		g_reset_status = RESET_STATUS_IDLE;
		reset_redraw_flag = true;
		break;
	}
}

void FactoryResetStartCallBack(struct k_timer *timer_id)
{
	reset_start_flag = true;
}

void SaveSystemDateTime(void)
{
	SaveDateTimeToInnerFlash(date_time);
}

void ResetSystemTime(void)
{
	memcpy(&date_time, &FACTORY_DEFAULT_TIME, sizeof(sys_date_timer_t));
	SaveSystemDateTime();
}

void InitSystemDateTime(void)
{
	sys_date_timer_t mytime = {0};

	ReadDateTimeFromInnerFlash(&mytime);
	
	if(!CheckSystemDateTimeIsValid(mytime))
	{
		memcpy(&mytime, &FACTORY_DEFAULT_TIME, sizeof(sys_date_timer_t));
	}
	memcpy(&date_time, &mytime, sizeof(sys_date_timer_t));

	SaveSystemDateTime();
	StartSystemDateTime();
}

void SaveSystemSettings(void)
{
	SaveSettingsToInnerFlash(global_settings);
}

void ResetSystemSettings(void)
{
	memcpy(&global_settings, &FACTORY_DEFAULT_SETTINGS, sizeof(global_settings_t));
	SaveSystemSettings();
}

void InitSystemSettings(void)
{
	int err;

	ReadSettingsFromInnerFlash(&global_settings);

	switch(global_settings.flag)
	{
	case SETTINGS_STATUS_INIT:
		ResetInnerFlash();
		memcpy(&global_settings, &FACTORY_DEFAULT_SETTINGS, sizeof(global_settings_t));
		SaveSystemSettings();
		break;

	case SETTINGS_STATUS_OTA:
		memcpy(&global_settings, &FACTORY_DEFAULT_SETTINGS, sizeof(global_settings_t));
		SaveSystemSettings();
		break;
		
	case SETTINGS_STATUS_NORMAL:
		break;		
	}

	InitSystemDateTime();
#ifdef CONFIG_ALARM_SUPPORT	
	AlarmRemindInit();
#endif
	mmi_chset_init();
}

void ResetLocalData(void)
{
	clear_cur_local_in_record();
	clear_local_in_record();
}

void ResetHealthData(void)
{
#if defined(CONFIG_PPG_SUPPORT)||defined(CONFIG_TEMP_SUPPORT)
	clear_cur_health_in_record();
	clear_health_in_record();
#endif

#ifdef CONFIG_PPG_SUPPORT
	ClearAllHrRecData();
	ClearAllSpo2RecData();
	ClearAllBptRecData();
	sh_clear_bpt_cal_data();
#endif

#ifdef CONFIG_TEMP_SUPPORT
	ClearAllTempRecData();
#endif
}

void ResetSportData(void)
{
#if defined(CONFIG_IMU_SUPPORT)&&(defined(CONFIG_STEP_SUPPORT)||defined(CONFIG_SLEEP_SUPPORT))
	clear_cur_sport_in_record();
	clear_sport_in_record();
#endif

#ifdef CONFIG_IMU_SUPPORT
#ifdef CONFIG_STEP_SUPPORT
	ClearAllStepRecData();
#endif

#ifdef CONFIG_SLEEP_SUPPORT
	ClearAllSleepRecData();
#endif
#endif
}

void ResetFactoryDefault(void)
{
	ResetSystemTime();
	ResetSystemSettings();

	ResetLocalData();
	ResetHealthData();
	ResetSportData();

	LogClear();

	if((screen_id == SCREEN_ID_SETTINGS) && (settings_menu.id == SETTINGS_MENU_FACTORY_RESET))
	{
		if(k_timer_remaining_get(&reset_timer) > 0)
			k_timer_stop(&reset_timer);
		
		g_reset_status = RESET_STATUS_SUCCESS;
		reset_redraw_flag = true;
	}
}

void ResetUpdateStatus(void)
{
	switch(g_reset_status)
	{
	case RESET_STATUS_IDLE:
		memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
		settings_menu.index = main_menu_index_bk;
		break;

	case RESET_STATUS_RUNNING:
		break;

	case RESET_STATUS_SUCCESS:
	case RESET_STATUS_FAIL:
		k_timer_start(&reset_timer, K_MSEC(1000), K_NO_WAIT);
		break;
	}
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void ReturnFTFotaMenu(void)
{
	LCD_Set_BL_Mode(LCD_BL_AUTO);
	
	main_menu_index_bk = settings_menu.index;
	memcpy(&settings_menu, &SETTING_MENU_OTA_UPDATE, sizeof(settings_menu_t));

	screen_id = SCREEN_ID_SETTINGS;
	scr_msg[screen_id].status = SCREEN_STATUS_CREATED;
	scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
}

void SettingsMenuDumpProc(void)
{
}

void SettingsMainMenu1Proc(void)
{
	main_menu_index_bk = settings_menu.index;
	
	memcpy(&settings_menu, &SETTING_MENU_LANGUAGE, sizeof(settings_menu_t));

	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMainMenu2Proc(void)
{
	main_menu_index_bk = settings_menu.index;

	memcpy(&settings_menu, &SETTING_MENU_BRIGHTNESS, sizeof(settings_menu_t));

	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}	
}

void SettingsMainMenu3Proc(void)
{
	main_menu_index_bk = settings_menu.index;
	
	memcpy(&settings_menu, &SETTING_MENU_TEMP, sizeof(settings_menu_t));

	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMainMenu4Proc(void)
{
	main_menu_index_bk = settings_menu.index;
	
	memcpy(&settings_menu, &SETTING_MENU_DEVICE, sizeof(settings_menu_t));

	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMainMenu5Proc(void)
{
	main_menu_index_bk = settings_menu.index;
	
	memcpy(&settings_menu, &SETTING_MENU_CAREMATE_QR, sizeof(settings_menu_t));

	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMainMenu6Proc(void)
{
	main_menu_index_bk = settings_menu.index;
	
	memcpy(&settings_menu, &SETTING_MENU_FACTORY_RESET, sizeof(settings_menu_t));

	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMainMenu7Proc(void)
{
#ifdef CONFIG_FOTA_DOWNLOAD
	extern uint8_t g_new_fw_ver[64];

	if((strcmp(g_new_fw_ver,g_fw_version) != 0)
		#ifdef NB_SIGNAL_TEST
		 || 1
		#endif
		)
	{
		fota_start();
	}
	else
#endif		
	{
	#if 1	//xb add 2024-03-19 ��ǿ���������һ�ΰ汾��Ϣ
		EnterVerCheckScreen();
	#else
		main_menu_index_bk = settings_menu.index;
		memcpy(&settings_menu, &SETTING_MENU_OTA_UPDATE, sizeof(settings_menu_t));

		if(screen_id == SCREEN_ID_SETTINGS)
		{
			scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
		}
	#endif
	}
}

void SettingsMenuLang1Proc(void)
{
	if(global_settings.language != LANGUAGE_BEGIN+0)
	{
		global_settings.language = LANGUAGE_BEGIN+0;
		need_save_settings = true;
	}

	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuLang2Proc(void)
{
	if(global_settings.language != LANGUAGE_BEGIN+1)
	{
		global_settings.language = LANGUAGE_BEGIN+1;
		need_save_settings = true;
	}

	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuLang3Proc(void)
{
	if(global_settings.language != LANGUAGE_BEGIN+2)
	{
		global_settings.language = LANGUAGE_BEGIN+2;
		need_save_settings = true;
	}

	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuLang4Proc(void)
{
	if(global_settings.language != LANGUAGE_BEGIN+3)
	{
		global_settings.language = LANGUAGE_BEGIN+3;
		need_save_settings = true;
	}

	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuLang5Proc(void)
{
	if(global_settings.language != LANGUAGE_BEGIN+4)
	{
		global_settings.language = LANGUAGE_BEGIN+4;
		need_save_settings = true;
	}

	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuLang6Proc(void)
{
	if(global_settings.language != LANGUAGE_BEGIN+5)
	{
		global_settings.language = LANGUAGE_BEGIN+5;
		need_save_settings = true;
	}

	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuReset1Proc(void)
{
	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuReset2Proc(void)
{
	g_reset_status = RESET_STATUS_RUNNING;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}

	k_timer_start(&reset_start_timer, K_MSEC(100), K_NO_WAIT);
}

void SettingsMenuCaremateQRProc(void)
{
	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuOTAProc(void)
{
	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuBrightness1Proc(void)
{
	if(global_settings.backlight_level > BACKLIGHT_LEVEL_MIN)
	{
		global_settings.backlight_level--;
		need_save_settings = true;
		need_reset_bk_level = true;

		if(screen_id == SCREEN_ID_SETTINGS)
		{
			scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
		}
	}
}

void SettingsMenuBrightness2Proc(void)
{
	if(global_settings.backlight_level < BACKLIGHT_LEVEL_MAX)
	{
		global_settings.backlight_level++;
		need_save_settings = true;
		need_reset_bk_level = true;

		if(screen_id == SCREEN_ID_SETTINGS)
		{
			scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
		}
	}
}

void SettingsMenuBrightness3Proc(void)
{
	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuTemp1Proc(void)
{
	if(global_settings.temp_unit != TEMP_UINT_C)
	{
		global_settings.temp_unit = TEMP_UINT_C;
		need_save_settings = true;
	}

	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuTemp2Proc(void)
{
	if(global_settings.temp_unit != TEMP_UINT_F)
	{
		global_settings.temp_unit = TEMP_UINT_F;
		need_save_settings = true;
	}

	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuDeviceProc(void)
{
	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));
	settings_menu.index = main_menu_index_bk;
	
	if(screen_id == SCREEN_ID_SETTINGS)
	{
		scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuPgUpProc(void)
{
	uint8_t count;
	
	if(settings_menu.id == SETTINGS_MENU_MAIN)
		count = SETTINGS_MAIN_MENU_MAX_PER_PG;
	else
		count = SETTINGS_SUB_MENU_MAX_PER_PG;
	
	if(settings_menu.index < (settings_menu.count - count))
	{
		settings_menu.index += count;
		if(screen_id == SCREEN_ID_SETTINGS)
			scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuPgDownProc(void)
{
	uint8_t count;

	if(settings_menu.id == SETTINGS_MENU_MAIN)
		count = SETTINGS_MAIN_MENU_MAX_PER_PG;
	else
		count = SETTINGS_SUB_MENU_MAX_PER_PG;
	
	if(settings_menu.index >= count)
	{
		settings_menu.index -= count;
		if(screen_id == SCREEN_ID_SETTINGS)
			scr_msg[screen_id].act = SCREEN_ACTION_UPDATE;
	}
}

void SettingsMenuPgLeftProc(void)
{
}

void SettingsMenuPgRightProc(void)
{
}

void SettingsMsgPorcess(void)
{
	if(need_save_time)
	{
		SaveSystemDateTime();
		need_save_time = false;
	}
	
	if(need_save_settings)
	{
		need_save_settings = false;
		SaveSystemSettings();
		SendSettingsData();
	}

	if(need_reset_settings)
	{
		need_reset_settings = false;
		k_timer_start(&reset_timer, K_MSEC(1000), K_NO_WAIT);
		ResetFactoryDefault();
	}
	if(need_reset_bk_level)
	{
		need_reset_bk_level = false;
		Set_Screen_Backlight_Level(global_settings.backlight_level);
	}
	if(reset_redraw_flag)
	{
		reset_redraw_flag = false;
		ResetUpdateStatus();
	}
	if(reset_start_flag)
	{
		reset_start_flag = false;
		k_timer_start(&reset_timer, K_MSEC(1000), K_NO_WAIT);
		ResetFactoryDefault();
	}
	if(reset_reboot_flag)
	{
		reset_reboot_flag = false;
		LCD_Clear(BLACK);
		sys_reboot(0);
	}
}

void EnterSettings(void)
{
	memcpy(&settings_menu, &SETTING_MAIN_MENU, sizeof(settings_menu_t));

	EnterSettingsScreen();
}
